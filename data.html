<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Table - KKP Reports</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            width: 100%;
            max-width: 1400px;
            background: #4a6cf7;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
        }
        
        .back-btn:hover {
            background: #5a6268;
        }
        
        .data-container {
            width: 100%;
            max-width: 1400px;
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            margin: 0 auto;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .page-title {
            text-align: center;
            margin-bottom: 25px;
            color: #4a6cf7;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .data-table th {
            background-color: #4a6cf7;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }
        
        .data-table th.sortable:hover {
            background-color: #3a5cd5;
        }
        
        .data-table th .sort-indicator {
            margin-left: 5px;
            font-size: 12px;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            text-align: center;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .data-table tr:hover {
            background-color: #f1f3ff;
        }
        
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 300px;
            max-width: 100%;
        }
        
        .entries-info {
            color: #666;
            font-size: 14px;
        }
        
        .pagination {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            align-items: center;
        }
        
        .pagination button {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #e9ecef;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background: #4a6cf7;
            color: white;
            border-color: #4a6cf7;
        }
        
        .pagination-info {
            margin: 0 15px;
            color: #666;
            font-size: 14px;
        }
        
        /* Button Container Styles */
        .button-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: nowrap;
        }
        
        .view-btn, .download-btn, .export-btn {
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 80px;
        }
        
        .view-btn {
            background: #17a2b8;
            color: white;
        }
        
        .view-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        .download-btn {
            background: #28a745;
            color: white;
        }
        
        .download-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .export-btn {
            background: #6f42c1;
            color: white;
            margin-left: 10px;
        }
        
        .export-btn:hover {
            background: #5e35b1;
            transform: translateY(-1px);
        }
        
        /* Clear Button Styles */
        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .clear-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .clear-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Enhanced Filter Controls */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }
        
        /* PDF Viewer Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }
        
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border: none;
            border-radius: 10px;
            width: 90%;
            height: 90vh;
            max-width: 1200px;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 25px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close:hover,
        .close:focus {
            color: #fff;
            background: rgba(0,0,0,0.7);
            text-decoration: none;
        }
        
        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 10px;
        }
        
        .modal-header {
            position: absolute;
            top: 15px;
            left: 25px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            z-index: 1001;
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 5px;
        }
        
        /* Confirmation Modal Styles */
        .confirmation-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        
        .confirmation-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
        
        .confirm-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            min-width: 100px;
        }
        
        .confirm-btn:hover {
            background: #c82333;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            min-width: 100px;
        }
        
        .cancel-btn:hover {
            background: #5a6268;
        }
        
        .confirmation-message {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .confirmation-warning {
            font-size: 14px;
            color: #dc3545;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 16px;
        }
        
        .error-message {
            text-align: center;
            padding: 20px;
            color: #dc3545;
            font-size: 16px;
        }
        
        .accident-details {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        @media (max-width: 1024px) {
            .data-container {
                max-width: 95%;
                padding: 20px;
            }
            
            .header {
                max-width: 95%;
            }
            
            .data-table th,
            .data-table td {
                padding: 12px;
                font-size: 13px;
            }
            
            .view-btn, .download-btn, .export-btn {
                padding: 6px 10px;
                font-size: 12px;
                min-width: 70px;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .table-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .search-box {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, 
            .data-table td {
                padding: 8px 10px;
                font-size: 12px;
            }
            
            .button-container {
                flex-direction: column;
                gap: 5px;
            }
            
            .view-btn, .download-btn, .export-btn {
                width: 100%;
                text-align: center;
            }
            
            .modal-content {
                width: 95%;
                height: 85vh;
                margin: 5% auto;
            }
            
            .close {
                top: 10px;
                right: 15px;
                font-size: 30px;
                width: 40px;
                height: 40px;
            }
            
            .modal-header {
                top: 10px;
                left: 15px;
                font-size: 14px;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .filter-select, .clear-btn, .export-btn {
                width: 100%;
                text-align: center;
            }
            
            .confirmation-content {
                margin: 20% auto;
                padding: 20px;
                width: 95%;
            }
            
            .confirmation-buttons {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .data-table {
                font-size: 11px;
            }
            
            .data-table th, 
            .data-table td {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            .view-btn, .download-btn, .export-btn {
                font-size: 11px;
                padding: 5px 8px;
                min-width: 60px;
            }
            
            .page-title h2 {
                font-size: 18px;
            }
            
            .page-title p {
                font-size: 14px;
            }
            
            .confirmation-message {
                font-size: 16px;
            }
            
            .confirm-btn, .cancel-btn {
                width: 100%;
            }
        }
    </style>

    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- PDF Viewer Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header" id="pdfTitle">KKP Report</div>
            <iframe id="pdfViewer" class="pdf-viewer" frameborder="0"></iframe>
        </div>
    </div>

    <!-- Clear Data Confirmation Modal -->
    <div id="clearDataModal" class="confirmation-modal">
        <div class="confirmation-content">
            <div class="confirmation-message">Are you sure you want to clear ALL data?</div>
            <div class="confirmation-warning">This action cannot be undone!</div>
            <div class="confirmation-buttons">
                <button class="confirm-btn" id="confirmClearBtn">Yes, Clear All</button>
                <button class="cancel-btn" id="cancelClearBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="header">
        <h1>Data Table - KKP Reports</h1>
        <div>
            <a href="index.html" class="back-btn">Back to Dashboard</a>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>
    
    <div class="data-container">
        <div class="page-title">
            <h2>KKP Reports Data</h2>
            <p>View and manage all submitted KKP reports</p>
        </div>
        
        <!-- Enhanced Filter Controls -->
        <div class="filter-controls">
            <select class="filter-select" id="divisionFilter">
                <option value="">All Divisions</option>
            </select>
            <select class="filter-select" id="quarterFilter">
                <option value="">All Quarters</option>
                <option value="Q1">Q1</option>
                <option value="Q2">Q2</option>
                <option value="Q3">Q3</option>
                <option value="Q4">Q4</option>
            </select>
            <input type="month" class="filter-select" id="dateFilter">
            <button class="export-btn" id="exportBtn">Export to CSV</button>
            <!-- Add Clear Data Button -->
            <button class="clear-btn" id="clearDataBtn">Clear All Data</button>
        </div>
        
        <div class="table-controls">
            <div class="entries-info">
                Show <select id="entriesSelect">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select> entries
            </div>
            
            <div>
                <input type="text" class="search-box" id="searchInput" placeholder="Search reports..." aria-label="Search reports">
            </div>
        </div>
        
        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    <th class="sortable" data-sort="index">No. <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="division">Bahagian/Unit <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="quarter">Suku <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="deathCases">Kematian <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="severeAccidents">Kemalangan Parah <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="totalAccidents">Jumlah Kemalangan <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="certifierName">Di sediakan oleh <span class="sort-indicator">↕</span></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="8" class="loading">Loading reports...</td>
                </tr>
            </tbody>
        </table>
        
        <div class="pagination" id="pagination">
            <button id="firstBtn">First</button>
            <button id="prevBtn">Previous</button>
            <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
            <button id="nextBtn">Next</button>
            <button id="lastBtn">Last</button>
        </div>
    </div>

    <script>
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAjMn3H2FKy87-m6VDq9AuPKt5CqMBy8K4",
            authDomain: "lpkkp-ed2c7.firebaseapp.com",
            projectId: "lpkkp-ed2c7",
            storageBucket: "lpkkp-ed2c7.firebasestorage.app",
            messagingSenderId: "627472582025",
            appId: "1:627472582025:web:f9c96d7f5c02437e4d8d58",
            measurementId: "G-6WM3EKJGMV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Get DOM elements
        const logoutBtn = document.getElementById('logoutBtn');
        const searchInput = document.getElementById('searchInput');
        const tableBody = document.getElementById('tableBody');
        const pdfModal = document.getElementById('pdfModal');
        const pdfViewer = document.getElementById('pdfViewer');
        const pdfTitle = document.getElementById('pdfTitle');
        const closeModal = document.querySelector('.close');
        const exportBtn = document.getElementById('exportBtn');
        const divisionFilter = document.getElementById('divisionFilter');
        const quarterFilter = document.getElementById('quarterFilter');
        const dateFilter = document.getElementById('dateFilter');
        
        // Clear data elements
        const clearDataBtn = document.getElementById('clearDataBtn');
        const clearDataModal = document.getElementById('clearDataModal');
        const confirmClearBtn = document.getElementById('confirmClearBtn');
        const cancelClearBtn = document.getElementById('cancelClearBtn');
        
        // Server-side pagination variables
        let allReports = [];
        let currentReports = [];
        let currentPage = 1;
        let entriesPerPage = 10;
        let sortColumn = 'createdAt';
        let sortDirection = 'desc';
        let lastVisibleDoc = null;
        let firstVisibleDoc = null;
        let totalReports = 0;
        let searchTimeout = null;

        // Utility function for safe data access
        function safeGetValue(value, fallback = 'N/A') {
            return value || value === 0 ? value : fallback;
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Check if user is logged in
        window.addEventListener('DOMContentLoaded', () => {
            const savedEmail = localStorage.getItem('userEmail');
            if (!savedEmail) {
                window.location.href = 'login.html';
            } else {
                initializePagination();
                setupEventListeners();
            }
        });

        // Initialize pagination and load data
        function initializePagination() {
            // Get total count
            db.collection('kkpReports').get().then((snapshot) => {
                totalReports = snapshot.size;
                loadDivisionFilter();
                loadReports(1);
            }).catch((error) => {
                console.error('Error getting total count: ', error);
                loadDivisionFilter();
                loadReports(1);
            });
        }

        // Load division filter separately
        function loadDivisionFilter() {
            db.collection('kkpReports')
                .orderBy('division')
                .get()
                .then((querySnapshot) => {
                    const divisions = new Set();
                    querySnapshot.forEach((doc) => {
                        const division = doc.data().division;
                        if (division) divisions.add(division);
                    });
                    
                    updateDivisionFilter(divisions);
                })
                .catch((error) => {
                    console.error('Error loading divisions: ', error);
                });
        }

        function updateDivisionFilter(divisions) {
            divisionFilter.innerHTML = '<option value="">All Divisions</option>';
            divisions.forEach(division => {
                const option = document.createElement('option');
                option.value = division;
                option.textContent = division;
                divisionFilter.appendChild(option);
            });
        }

        // Server-side pagination: Load reports with filters
        function loadReports(page = 1) {
            tableBody.innerHTML = '<tr><td colspan="8" class="loading">Loading reports...</td></tr>';
            
            const filters = getCurrentFilters();
            let query = db.collection('kkpReports');
            
            // Apply filters
            if (filters.division) {
                query = query.where('division', '==', filters.division);
            }
            if (filters.quarter) {
                query = query.where('quarter', '==', filters.quarter);
            }
            if (filters.date) {
                // For date filtering, you might need to adjust based on your date field
                query = query.where('reportDate', '>=', filters.date + '-01')
                            .where('reportDate', '<=', filters.date + '-31');
            }
            
            // Apply sorting
            query = query.orderBy('createdAt', 'desc');
            
            // Handle pagination
            if (page > currentPage && lastVisibleDoc) {
                // Next page
                query = query.startAfter(lastVisibleDoc);
            } else if (page < currentPage) {
                // For previous pages, reset and calculate offset
                // Note: Firestore doesn't support direct offset, so we reset
                lastVisibleDoc = null;
                currentPage = 1;
                // We'll handle this by going back to first page and navigating forward
                // For complex previous navigation, consider alternative approaches
            }
            
            query = query.limit(entriesPerPage);
            
            query.get().then((querySnapshot) => {
                if (querySnapshot.empty && page > 1) {
                    // If no results on non-first page, go back to first page
                    currentPage = 1;
                    loadReports(1);
                    return;
                }
                
                // Store pagination markers
                if (!querySnapshot.empty) {
                    lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    firstVisibleDoc = querySnapshot.docs[0];
                }
                
                allReports = [];
                querySnapshot.forEach((doc) => {
                    const report = doc.data();
                    report.id = doc.id;
                    allReports.push(report);
                });
                
                currentPage = page;
                currentReports = [...allReports];
                displayReports(currentReports);
                
            }).catch((error) => {
                console.error('Error loading reports: ', error);
                tableBody.innerHTML = '<tr><td colspan="8" class="error-message">Error loading reports. Please try again.</td></tr>';
            });
        }

        // Get current filter values
        function getCurrentFilters() {
            const searchText = searchInput.value.toLowerCase();
            return {
                division: divisionFilter.value || null,
                quarter: quarterFilter.value || null,
                date: dateFilter.value || null,
                search: searchText || null
            };
        }

        // Setup event listeners
        function setupEventListeners() {
            logoutBtn.addEventListener('click', handleLogout);
            closeModal.addEventListener('click', closePdfModal);
            exportBtn.addEventListener('click', exportToCSV);
            
            // Sorting
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.getAttribute('data-sort');
                    handleSort(column);
                });
            });
            
            // Filtering
            divisionFilter.addEventListener('change', applyFilters);
            quarterFilter.addEventListener('change', applyFilters);
            dateFilter.addEventListener('change', applyFilters);
            
            // Pagination
            document.getElementById('entriesSelect').addEventListener('change', function() {
                entriesPerPage = parseInt(this.value);
                currentPage = 1;
                lastVisibleDoc = null;
                loadReports(1);
            });
            
            document.getElementById('firstBtn').addEventListener('click', () => goToPage(1));
            document.getElementById('prevBtn').addEventListener('click', () => goToPage(currentPage - 1));
            document.getElementById('nextBtn').addEventListener('click', () => goToPage(currentPage + 1));
            document.getElementById('lastBtn').addEventListener('click', () => {
                const totalPages = Math.ceil(totalReports / entriesPerPage);
                goToPage(totalPages);
            });
            
            // Search with debouncing
            searchInput.addEventListener('keyup', debounce(function() {
                applyFilters();
            }, 300));
            
            // Clear data functionality
            clearDataBtn.addEventListener('click', showClearConfirmation);
            confirmClearBtn.addEventListener('click', clearAllData);
            cancelClearBtn.addEventListener('click', hideClearConfirmation);
            
            // Close modals when clicking outside
            clearDataModal.addEventListener('click', function(e) {
                if (e.target === clearDataModal) {
                    hideClearConfirmation();
                }
            });
            
            pdfModal.addEventListener('click', function(e) {
                if (e.target === pdfModal) {
                    closePdfModal();
                }
            });
            
            // Escape key for modals
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    if (pdfModal.style.display === 'block') {
                        closePdfModal();
                    }
                    if (clearDataModal.style.display === 'block') {
                        hideClearConfirmation();
                    }
                }
            });
        }

        function handleLogout() {
            localStorage.removeItem('userEmail');
            window.location.href = 'login.html';
        }

        function closePdfModal() {
            pdfModal.style.display = 'none';
            pdfViewer.src = '';
        }

        // Apply filters and reload data
        function applyFilters() {
            currentPage = 1;
            lastVisibleDoc = null;
            loadReports(1);
        }

        // Navigation functions
        function goToPage(page) {
            if (page < 1) page = 1;
            
            const totalPages = Math.ceil(totalReports / entriesPerPage);
            if (page > totalPages) page = totalPages;
            
            if (page === currentPage) return;
            
            loadReports(page);
        }

        // Show confirmation modal for clearing data
        function showClearConfirmation() {
            if (totalReports === 0) {
                alert('No data to clear.');
                return;
            }
            clearDataModal.style.display = 'block';
        }

        // Hide confirmation modal
        function hideClearConfirmation() {
            clearDataModal.style.display = 'none';
        }

        // Clear all data from Firestore
        function clearAllData() {
            const originalText = clearDataBtn.textContent;
            
            // Show loading state
            clearDataBtn.disabled = true;
            clearDataBtn.textContent = 'Clearing...';
            hideClearConfirmation();
            
            // Get all documents and delete them in batches
            const batchSize = 500;
            const deleteBatch = (query) => {
                query.limit(batchSize).get().then((snapshot) => {
                    if (snapshot.size === 0) {
                        // All documents deleted
                        resetAfterClear();
                        alert('All data has been cleared successfully.');
                        return;
                    }
                    
                    // Delete documents in batch
                    const batch = db.batch();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    return batch.commit().then(() => {
                        // Recurse on the next batch
                        return deleteBatch(query);
                    });
                });
            };
            
            // Start deletion
            deleteBatch(db.collection('kkpReports'))
                .catch((error) => {
                    console.error('Error clearing data: ', error);
                    alert('Error clearing data. Please try again.');
                })
                .finally(() => {
                    // Reset button state
                    clearDataBtn.disabled = false;
                    clearDataBtn.textContent = originalText;
                });
        }

        function resetAfterClear() {
            // Reset all data
            allReports = [];
            currentReports = [];
            currentPage = 1;
            lastVisibleDoc = null;
            totalReports = 0;
            
            // Update UI
            displayReports(currentReports);
            
            // Reset division filter
            divisionFilter.innerHTML = '<option value="">All Divisions</option>';
            
            // Reload total count
            initializePagination();
        }

        // Handle sorting (client-side for current page)
        function handleSort(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.sortable').forEach(th => {
                const indicator = th.querySelector('.sort-indicator');
                if (th.getAttribute('data-sort') === sortColumn) {
                    indicator.textContent = sortDirection === 'asc' ? '↑' : '↓';
                } else {
                    indicator.textContent = '↕';
                }
            });
            
            sortReports();
            displayReports(currentReports);
        }

        function sortReports() {
            currentReports.sort((a, b) => {
                let aValue = a[sortColumn];
                let bValue = b[sortColumn];
                
                // Handle special cases
                if (sortColumn === 'index') {
                    return sortDirection === 'asc' ? 1 : -1;
                }
                if (sortColumn === 'totalAccidents') {
                    aValue = calculateTotalAccidents(a);
                    bValue = calculateTotalAccidents(b);
                }
                
                if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Calculate total accidents based on your requirements
        function calculateTotalAccidents(report) {
            return (
                parseInt(safeGetValue(report.severeAccidents, 0)) +        // 1.2 Kemalangan Parah
                parseInt(safeGetValue(report.medicalCases, 0)) +           // 2.1 Kes Rawatan Perubatan
                parseInt(safeGetValue(report.firstAidCases, 0)) +          // 2.2 Kes Rawatan Kecil (First Aid)
                parseInt(safeGetValue(report.occupationalDisease, 0)) +    // 2.3 Penyakit Pekerjaan
                parseInt(safeGetValue(report.fireCases, 0)) +              // 3.1 Kebakaran
                parseInt(safeGetValue(report.propertyDamage, 0)) +         // 3.2 Kerosakan Harta Benda
                parseInt(safeGetValue(report.commutingAccidents, 0)) +     // 3.3 Kemalangan dalam Perjalanan
                parseInt(safeGetValue(report.nearMiss, 0))                 // 3.4 Kejadian Hampir (Near Miss)
            );
        }

        // Get accident details for display
        function getAccidentDetails(report) {
            const details = [];
            if (report.severeAccidents && parseInt(report.severeAccidents) > 0) details.push(`Parah: ${report.severeAccidents}`);
            if (report.medicalCases && parseInt(report.medicalCases) > 0) details.push(`Perubatan: ${report.medicalCases}`);
            if (report.firstAidCases && parseInt(report.firstAidCases) > 0) details.push(`First Aid: ${report.firstAidCases}`);
            if (report.occupationalDisease && parseInt(report.occupationalDisease) > 0) details.push(`Penyakit: ${report.occupationalDisease}`);
            if (report.fireCases && parseInt(report.fireCases) > 0) details.push(`Kebakaran: ${report.fireCases}`);
            if (report.propertyDamage && parseInt(report.propertyDamage) > 0) details.push(`Kerosakan: ${report.propertyDamage}`);
            if (report.commutingAccidents && parseInt(report.commutingAccidents) > 0) details.push(`Perjalanan: ${report.commutingAccidents}`);
            if (report.nearMiss && parseInt(report.nearMiss) > 0) details.push(`Near Miss: ${report.nearMiss}`);
            
            return details.length > 0 ? details.join(', ') : 'Tiada kemalangan';
        }

        // Display reports in the table
        function displayReports(reports) {
            currentReports = reports;
            
            tableBody.innerHTML = '';
            
            if (reports.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8">No reports found.</td></tr>';
                updatePagination();
                return;
            }
            
            reports.forEach((report, index) => {
                const globalIndex = ((currentPage - 1) * entriesPerPage) + index + 1;
                const totalAccidents = calculateTotalAccidents(report);
                const accidentDetails = getAccidentDetails(report);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${globalIndex}</td>
                    <td>${safeGetValue(report.division)}</td>
                    <td>${safeGetValue(report.quarter)}</td>
                    <td>${safeGetValue(report.deathCases, '0')}</td>
                    <td>${safeGetValue(report.severeAccidents, '0')}</td>
                    <td>
                        ${totalAccidents}
                        <div class="accident-details">${accidentDetails}</div>
                    </td>
                    <td>${safeGetValue(report.certifierName)}</td>
                    <td>
                        <div class="button-container">
                            <button class="view-btn" data-id="${report.id}" aria-label="View PDF for ${report.division} ${report.quarter} report">View PDF</button>
                            <button class="download-btn" data-id="${report.id}" aria-label="Download ${report.division} ${report.quarter} report">Download</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const reportId = e.target.getAttribute('data-id');
                    viewPdf(reportId);
                });
            });
            
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const reportId = e.target.getAttribute('data-id');
                    downloadReport(reportId);
                });
            });
            
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalReports / entriesPerPage);
            const pageInfo = document.getElementById('pageInfo');
            const firstBtn = document.getElementById('firstBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const lastBtn = document.getElementById('lastBtn');
            
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            firstBtn.disabled = currentPage === 1;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            lastBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // View PDF in modal
        function viewPdf(reportId) {
            const report = allReports.find(r => r.id === reportId);
            if (!report || !report.pdfData) {
                alert('PDF not available for this report');
                return;
            }
            
            pdfTitle.textContent = `KKP Report - ${safeGetValue(report.division)} - ${safeGetValue(report.quarter)}`;
            pdfViewer.src = report.pdfData;
            pdfModal.style.display = 'block';
        }

        // Download the EXACT PDF that was originally generated
        function downloadReport(reportId) {
            const report = allReports.find(r => r.id === reportId);
            if (!report || !report.pdfData) {
                alert('PDF not available for this report');
                return;
            }
            
            const link = document.createElement('a');
            link.href = report.pdfData;
            link.download = `KKP_Report_${safeGetValue(report.division, 'Unknown')}_${safeGetValue(report.quarter, 'Unknown')}.pdf`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // =========================================================================
        // QUARTERLY SUMMARY CSV EXPORT FUNCTION (Based on Laporan KKP.xlsx)
        // =========================================================================



        function exportToCSV() {
            if (currentReports.length === 0) {
                alert('No data to export');
                return;
            }
            
            const csvRows = [];
            
            // Title and headers
            csvRows.push(',,,,LAPORAN KKP - DATA TERPERINCI');
            csvRows.push(',,,,');
            
            // Main headers
            const headers = [
                'No',
                'Bahagian/Unit',
                'Suku', 
                'Tarikh Laporan',
                'Pegawai Mengaku',
                // Section A: STATISTIK - BILANGAN only
                'A1. Jumlah Bilangan Pekerja',
                'A2. Jumlah Cuti Sakit Pekerja Disebabkan Kemalangan',
                // Section B: REKOD KES KEMALANGAN - BILANGAN KES only
                'B1.1 Kematian',
                'B1.2 Kemalangan Parah (Cuti Sakit ≥ 5 Hari)',
                'B2.1 Kes Rawatan Perubatan',
                'B2.2 Kes Rawatan Kecil (First Aid)',
                'B2.3 Penyakit Pekerjaan',
                'B3.1 Kebakaran',
                'B3.2 Kerosakan Harta Benda',
                'B3.3 Kemalangan dalam Perjalanan',
                'B3.4 Kejadian Hampir (Near Miss)',
                // Section C: REKOD KES BERKAITAN KESIHATAN - BILANGAN KES only
                'C1. Kes Penyakit Berjangkit',
                // Section D: PROGRAM KKP - BILANGAN only
                'D1. Jumlah Mesyuarat KKP',
                'D2. Jumlah Latihan KKP',
                'D3. Jumlah Taklimat/Toolbox',
                'D4. Jumlah Pemeriksaan KKP',
                'D5. Pelaporan UAUC',
                'D6. Lain-lain Aktiviti KKP',
                // Jumlah column
                'Jumlah'
            ];
            
            csvRows.push(headers.join(','));
            
            // Add data rows
            currentReports.forEach((report, index) => {
                const globalIndex = ((currentPage - 1) * entriesPerPage) + index + 1;
                
                // Calculate total for Jumlah column
                const total = calculateExportTotal(report);
                
                const row = [
                    globalIndex,
                    escapeCsvValue(report.division),
                    escapeCsvValue(report.quarter),
                    escapeCsvValue(report.reportDate),
                    escapeCsvValue(report.certifierName),
                    // Section A: BILANGAN only
                    safeGetValue(report.totalWorkers, '0'),
                    safeGetValue(report.sickLeave, '0'),
                    // Section B: BILANGAN KES only  
                    safeGetValue(report.deathCases, '0'),
                    safeGetValue(report.severeAccidents, '0'),
                    safeGetValue(report.medicalCases, '0'),
                    safeGetValue(report.firstAidCases, '0'),
                    safeGetValue(report.occupationalDisease, '0'),
                    safeGetValue(report.fireCases, '0'),
                    safeGetValue(report.propertyDamage, '0'),
                    safeGetValue(report.commutingAccidents, '0'),
                    safeGetValue(report.nearMiss, '0'),
                    // Section C: BILANGAN KES only
                    safeGetValue(report.infectiousDisease, '0'),
                    // Section D: BILANGAN only
                    safeGetValue(report.meetings, '0'),
                    safeGetValue(report.trainings, '0'),
                    safeGetValue(report.briefings, '0'),
                    safeGetValue(report.inspections, '0'),
                    safeGetValue(report.uauc, '0'),
                    safeGetValue(report.otherActivities, '0'),
                    // Jumlah column
                    total
                ];
                
                csvRows.push(row.join(','));
            });
            
            createAndDownloadCsv(csvRows, 'Laporan_KKP_Data_Terperinci');
        }

        // New function to calculate total for Jumlah column
        function calculateExportTotal(report) {
            const numericFields = [
                'totalWorkers', 'sickLeave',                    // Section A
                'deathCases', 'severeAccidents',               // Section B
                'medicalCases', 'firstAidCases',               // Section B
                'occupationalDisease', 'fireCases',            // Section B  
                'propertyDamage', 'commutingAccidents',        // Section B
                'nearMiss',                                    // Section B
                'infectiousDisease',                           // Section C
                'meetings', 'trainings', 'briefings',          // Section D
                'inspections', 'uauc', 'otherActivities'       // Section D
            ];
            
            let total = 0;
            numericFields.forEach(field => {
                const value = parseInt(safeGetValue(report[field], '0'));
                if (!isNaN(value)) {
                    total += value;
                }
            });
            
            return total;
        }

        // Group reports by quarter and calculate totals
        function groupReportsByQuarter(reports) {
            const quarterlyData = {
                'Q1': { deathCases: 0, severeAccidents: 0, totalAccidents: 0 },
                'Q2': { deathCases: 0, severeAccidents: 0, totalAccidents: 0 },
                'Q3': { deathCases: 0, severeAccidents: 0, totalAccidents: 0 },
                'Q4': { deathCases: 0, severeAccidents: 0, totalAccidents: 0 }
            };
            
            reports.forEach(report => {
                const quarter = report.quarter;
                if (quarterlyData[quarter]) {
                    quarterlyData[quarter].deathCases += parseInt(safeGetValue(report.deathCases, 0));
                    quarterlyData[quarter].severeAccidents += parseInt(safeGetValue(report.severeAccidents, 0));
                    quarterlyData[quarter].totalAccidents += calculateTotalAccidents(report);
                }
            });
            
            return quarterlyData;
        }

        // Proper CSV value escaping
        function escapeCsvValue(value) {
            if (value === null || value === undefined) return '';
            
            const stringValue = String(value);
            
            // Escape quotes and wrap in quotes if contains comma, quote, or newline
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') || stringValue.includes('\r')) {
                return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            
            return stringValue;
        }

        // Create and trigger download
        function createAndDownloadCsv(csvRows, filenamePrefix = 'Laporan_KKP') {
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().split('T')[0];
            link.setAttribute('download', `${filenamePrefix}_${timestamp}.csv`);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up URL object
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }
    </script>
</body>
</html>
