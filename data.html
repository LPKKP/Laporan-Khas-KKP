<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Table - KKP Reports</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            width: 100%;
            max-width: 1400px;
            background: #4a6cf7;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
        }
        
        .back-btn:hover {
            background: #5a6268;
        }
        
        .data-container {
            width: 100%;
            max-width: 1400px;
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            margin: 0 auto;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .page-title {
            text-align: center;
            margin-bottom: 25px;
            color: #4a6cf7;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .data-table th {
            background-color: #4a6cf7;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s;
        }
        
        .data-table th.sortable:hover {
            background-color: #3a5cd5;
        }
        
        .data-table th.sort-asc {
            background-color: #2a4cb3;
        }
        
        .data-table th.sort-desc {
            background-color: #2a4cb3;
        }
        
        .data-table th .sort-indicator {
            margin-left: 5px;
            font-size: 12px;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            text-align: center;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .data-table tr:hover {
            background-color: #f1f3ff;
        }
        
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 300px;
            max-width: 100%;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #4a6cf7;
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }
        
        .search-box.loading {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234a6cf7" width="18px" height="18px"><path d="M12 4V2A10 10 0 002 12h2a8 8 0 018-8z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }
        
        .entries-info {
            color: #666;
            font-size: 14px;
        }
        
        .pagination {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            align-items: center;
        }
        
        .pagination button {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #e9ecef;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background: #4a6cf7;
            color: white;
            border-color: #4a6cf7;
        }
        
        .pagination-info {
            margin: 0 15px;
            color: #666;
            font-size: 14px;
        }
        
        /* Button Container Styles */
        .button-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: nowrap;
        }
        
        .view-btn, .download-btn, .export-btn, .export-all-btn {
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 80px;
        }
        
        .view-btn {
            background: #17a2b8;
            color: white;
        }
        
        .view-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }
        
        .download-btn {
            background: #28a745;
            color: white;
        }
        
        .download-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .export-btn {
            background: #6f42c1;
            color: white;
        }
        
        .export-btn:hover {
            background: #5e35b1;
            transform: translateY(-1px);
        }
        
        /* Export All Button Styles */
        .export-all-btn {
            background: #fd7e14;
            color: white;
        }
        
        .export-all-btn:hover {
            background: #e96a10;
            transform: translateY(-1px);
        }
        
        .export-all-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Clear Button Styles */
        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .clear-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .clear-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Enhanced Filter Controls */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #4a6cf7;
        }
        
        .date-range-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-range-separator {
            color: #666;
            font-weight: bold;
        }
        
        /* Enhanced Search Results Indicator */
        .search-results-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #0066cc;
        }
        
        .search-results-info strong {
            color: #004d99;
        }
        
        /* PDF Viewer Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }
        
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border: none;
            border-radius: 10px;
            width: 90%;
            height: 90vh;
            max-width: 1200px;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 25px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close:hover,
        .close:focus {
            color: #fff;
            background: rgba(0,0,0,0.7);
            text-decoration: none;
        }
        
        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 10px;
        }
        
        .modal-header {
            position: absolute;
            top: 15px;
            left: 25px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            z-index: 1001;
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 5px;
        }
        
        /* Confirmation Modal Styles */
        .confirmation-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        
        .confirmation-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
        
        .confirm-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            min-width: 100px;
        }
        
        .confirm-btn:hover {
            background: #c82333;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            min-width: 100px;
        }
        
        .cancel-btn:hover {
            background: #5a6268;
        }
        
        .confirmation-message {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .confirmation-warning {
            font-size: 14px;
            color: #dc3545;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 16px;
        }
        
        .error-message {
            text-align: center;
            padding: 20px;
            color: #dc3545;
            font-size: 16px;
        }
        
        .accident-details {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* Loading indicator for export */
        .export-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .action-btn.active {
            background: #4a6cf7;
        }
        
        /* Export Options Styles */
        .export-options {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .export-options strong {
            display: block;
            margin-bottom: 10px;
            color: #495057;
            font-size: 14px;
        }
        
        .export-options .action-btn {
            margin-right: 8px;
            margin-bottom: 5px;
        }
        
        @media (max-width: 1024px) {
            .data-container {
                max-width: 95%;
                padding: 20px;
            }
            
            .header {
                max-width: 95%;
            }
            
            .data-table th,
            .data-table td {
                padding: 12px;
                font-size: 13px;
            }
            
            .view-btn, .download-btn, .export-btn, .export-all-btn {
                padding: 6px 10px;
                font-size: 12px;
                min-width: 70px;
            }
            
            .filter-controls {
                gap: 8px;
            }
            
            .date-range-container {
                flex-direction: column;
                gap: 5px;
            }
            
            .date-range-separator {
                display: none;
            }
            
            .export-options .action-btn {
                margin-right: 5px;
                font-size: 12px;
                padding: 6px 10px;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .table-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .search-box {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, 
            .data-table td {
                padding: 8px 10px;
                font-size: 12px;
            }
            
            .button-container {
                flex-direction: column;
                gap: 5px;
            }
            
            .view-btn, .download-btn, .export-btn, .export-all-btn {
                width: 100%;
                text-align: center;
            }
            
            .modal-content {
                width: 95%;
                height: 85vh;
                margin: 5% auto;
            }
            
            .close {
                top: 10px;
                right: 15px;
                font-size: 30px;
                width: 40px;
                height: 40px;
            }
            
            .modal-header {
                top: 10px;
                left: 15px;
                font-size: 14px;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .filter-select, .clear-btn, .export-btn, .export-all-btn {
                width: 100%;
                text-align: center;
            }
            
            .confirmation-content {
                margin: 20% auto;
                padding: 20px;
                width: 95%;
            }
            
            .confirmation-buttons {
                flex-direction: column;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                text-align: center;
            }
            
            .export-options .action-btn {
                width: 100%;
                margin-right: 0;
            }
        }
        
        @media (max-width: 480px) {
            .data-table {
                font-size: 11px;
            }
            
            .data-table th, 
            .data-table td {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            .view-btn, .download-btn, .export-btn, .export-all-btn {
                font-size: 11px;
                padding: 5px 8px;
                min-width: 60px;
            }
            
            .page-title h2 {
                font-size: 18px;
            }
            
            .page-title p {
                font-size: 14px;
            }
            
            .confirmation-message {
                font-size: 16px;
            }
            
            .confirm-btn, .cancel-btn {
                width: 100%;
            }
        }
    </style>

    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- PDF Viewer Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header" id="pdfTitle">KKP Report</div>
            <iframe id="pdfViewer" class="pdf-viewer" frameborder="0"></iframe>
        </div>
    </div>

    <!-- Clear Data Confirmation Modal -->
    <div id="clearDataModal" class="confirmation-modal">
        <div class="confirmation-content">
            <div class="confirmation-message">Are you sure you want to clear ALL data?</div>
            <div class="confirmation-warning">This action cannot be undone!</div>
            <div class="confirmation-buttons">
                <button class="confirm-btn" id="confirmClearBtn">Yes, Clear All</button>
                <button class="cancel-btn" id="cancelClearBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="header">
        <h1>Data Table - KKP Reports</h1>
        <div>
            <a href="index.html" class="back-btn">Back to Dashboard</a>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>
    
    <div class="data-container">
        <div class="page-title">
            <h2>KKP Reports Data</h2>
            <p>View and manage all submitted KKP reports</p>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="action-btn" id="sortNewestBtn">Sort: Newest First</button>
            <button class="action-btn" id="sortOldestBtn">Sort: Oldest First</button>
            <button class="action-btn" id="sortDivisionBtn">Sort: Division A-Z</button>
            <button class="action-btn" id="clearFiltersBtn">Clear All Filters</button>
        </div>
        
        <!-- Enhanced Filter Controls -->
        <div class="filter-controls">
            <select class="filter-select" id="divisionFilter">
                <option value="">All Divisions</option>
            </select>
            <select class="filter-select" id="quarterFilter">
                <option value="">All Quarters</option>
                <option value="Suku 1">Suku 1</option>
                <option value="Suku 2">Suku 2</option>
                <option value="Suku 3">Suku 3</option>
                <option value="Suku 4">Suku 4</option>
            </select>
            
            <!-- Date Range Filter -->
            <div class="date-range-container">
                <input type="date" class="filter-select" id="startDateFilter" placeholder="Start Date">
                <span class="date-range-separator">to</span>
                <input type="date" class="filter-select" id="endDateFilter" placeholder="End Date">
            </div>
            
            <button class="export-btn" id="exportBtn">Export Current Data</button>
            <button class="export-all-btn" id="exportAllBtn">Export All Data</button>
            <button class="clear-btn" id="clearDataBtn">Clear All Data</button>
        </div>
        
        <!-- Export Options -->
        <!-- ON HOLD -->
        <!-- <div class="export-options">
            <strong>Pilihan Eksport:</strong>
            <button class="action-btn" id="exportSummaryBtn">Ringkasan</button>
            <button class="action-btn" id="exportQuarterlyBtn">Mengikut Suku</button>
            <button class="action-btn" id="exportDetailedBtn">Terperinci</button>
            <button class="action-btn" id="exportAllDetailedBtn">Semua Data Terperinci</button>
        </div> -->
        
        <!-- Search Results Info -->
        <div id="searchResultsInfo" class="search-results-info" style="display: none;">
            Showing <strong id="resultsCount">0</strong> of <strong id="totalCount">0</strong> reports
            <span id="searchQueryInfo" style="display: none;"> for "<strong id="queryText"></strong>"</span>
            <span id="dateRangeInfo" style="display: none;"> within selected date range</span>
        </div>
        
        <div class="table-controls">
            <div class="entries-info">
                Show <select id="entriesSelect">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select> entries
            </div>
            
            <div>
                <input type="text" class="search-box" id="searchInput" placeholder="Search reports..." aria-label="Search reports">
            </div>
        </div>
        
        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    <th class="sortable" data-sort="index">No. <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="division">Bahagian/Unit <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="quarter">Suku <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="deathCases">Kematian <span class="sort-indicator">↕</span></th>
                    <!-- NEW COLUMNS -->
                    <th class="sortable" data-sort="majorAccidents">Kes Kemalangan Major <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="minorAccidents">Kes Kemalangan Minor <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="noInjuryAccidents">Kes Kemalangan Tiada Kecederaan <span class="sort-indicator">↕</span></th>
                    <!-- END NEW COLUMNS -->
                    <th class="sortable" data-sort="certifierName">Di sediakan oleh <span class="sort-indicator">↕</span></th>
                    <th class="sortable" data-sort="reportDate">Tarikh <span class="sort-indicator">↕</span></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="10" class="loading">Loading reports...</td>
                </tr>
            </tbody>
        </table>
        
        <div class="pagination" id="pagination">
            <button id="firstBtn">First</button>
            <button id="prevBtn">Previous</button>
            <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
            <button id="nextBtn">Next</button>
            <button id="lastBtn">Last</button>
        </div>
    </div>

    <script>
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAjMn3H2FKy87-m6VDq9AuPKt5CqMBy8K4",
            authDomain: "lpkkp-ed2c7.firebaseapp.com",
            projectId: "lpkkp-ed2c7",
            storageBucket: "lpkkp-ed2c7.firebasestorage.app",
            messagingSenderId: "627472582025",
            appId: "1:627472582025:web:f9c96d7f5c02437e4d8d58",
            measurementId: "G-6WM3EKJGMV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Get DOM elements
        const logoutBtn = document.getElementById('logoutBtn');
        const searchInput = document.getElementById('searchInput');
        const tableBody = document.getElementById('tableBody');
        const pdfModal = document.getElementById('pdfModal');
        const pdfViewer = document.getElementById('pdfViewer');
        const pdfTitle = document.getElementById('pdfTitle');
        const closeModal = document.querySelector('.close');
        const exportBtn = document.getElementById('exportBtn');
        const exportAllBtn = document.getElementById('exportAllBtn');
        const divisionFilter = document.getElementById('divisionFilter');
        const quarterFilter = document.getElementById('quarterFilter');
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const searchResultsInfo = document.getElementById('searchResultsInfo');
        const resultsCount = document.getElementById('resultsCount');
        const totalCount = document.getElementById('totalCount');
        const searchQueryInfo = document.getElementById('searchQueryInfo');
        const queryText = document.getElementById('queryText');
        const dateRangeInfo = document.getElementById('dateRangeInfo');
        
        // Quick action buttons
        const sortNewestBtn = document.getElementById('sortNewestBtn');
        const sortOldestBtn = document.getElementById('sortOldestBtn');
        const sortDivisionBtn = document.getElementById('sortDivisionBtn');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        
        // Clear data elements
        const clearDataBtn = document.getElementById('clearDataBtn');
        const clearDataModal = document.getElementById('clearDataModal');
        const confirmClearBtn = document.getElementById('confirmClearBtn');
        const cancelClearBtn = document.getElementById('cancelClearBtn');
        
        // Export option buttons
        const exportSummaryBtn = document.getElementById('exportSummaryBtn');
        const exportQuarterlyBtn = document.getElementById('exportQuarterlyBtn');
        const exportDetailedBtn = document.getElementById('exportDetailedBtn');
        const exportAllDetailedBtn = document.getElementById('exportAllDetailedBtn');
        
        // Client-side filtering variables
        let allReports = [];
        let filteredReports = [];
        let currentReports = [];
        let currentPage = 1;
        let entriesPerPage = 10;
        let sortColumn = 'createdAt';
        let sortDirection = 'desc';
        let totalReports = 0;
        let searchTimeout = null;
        let isSearching = false;

        // Export configuration options
        const exportOptions = {
            format: 'detailed', // 'summary', 'quarterly', 'detailed'
            includeMetadata: true,
            groupBy: 'none' // 'quarter', 'division', 'none'
        };

        // Utility function for safe data access
        function safeGetValue(value, fallback = 'N/A') {
            return value || value === 0 ? value : fallback;
        }

        // Enhanced debounce function for search
        function debounce(func, wait, immediate) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    timeout = null;
                    if (!immediate) func(...args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func(...args);
            };
        }

        // Check if user is logged in
        window.addEventListener('DOMContentLoaded', () => {
            const savedEmail = localStorage.getItem('userEmail');
            if (!savedEmail) {
                window.location.href = 'login.html';
            } else {
                loadAllReports();
                setupEventListeners();
                setupDefaultDates();
                setupEnhancedExportListeners();
            }
        });

        // Set default date range (last 30 days)
        function setupDefaultDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            startDateFilter.valueAsDate = startDate;
            endDateFilter.valueAsDate = endDate;
        }

        // Load all reports at once for client-side filtering
        function loadAllReports() {
            tableBody.innerHTML = '<tr><td colspan="10" class="loading">Loading reports...</td></tr>';
            
            db.collection('kkpReports')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    allReports = [];
                    querySnapshot.forEach((doc) => {
                        const report = doc.data();
                        report.id = doc.id;
                        allReports.push(report);
                    });
                    
                    totalReports = allReports.length;
                    loadDivisionFilter();
                    applyFilters(); // Apply initial filters
                    updateSearchResultsInfo();
                    
                }).catch((error) => {
                    console.error('Error loading reports: ', error);
                    tableBody.innerHTML = '<tr><td colspan="10" class="error-message">Error loading reports. Please try again.</td></tr>';
                });
        }

        // Load division filter from all reports
        function loadDivisionFilter() {
            const divisions = new Set();
            allReports.forEach(report => {
                const division = report.division;
                if (division) divisions.add(division);
            });
            
            updateDivisionFilter(divisions);
        }

        function updateDivisionFilter(divisions) {
            divisionFilter.innerHTML = '<option value="">All Divisions</option>';
            const divisionsArray = Array.from(divisions).sort();
            divisionsArray.forEach(division => {
                const option = document.createElement('option');
                option.value = division;
                option.textContent = division;
                divisionFilter.appendChild(option);
            });
        }

        // Get current filter values
        function getCurrentFilters() {
            const searchText = searchInput.value.toLowerCase().trim();
            return {
                division: divisionFilter.value || null,
                quarter: quarterFilter.value || null,
                startDate: startDateFilter.value || null,
                endDate: endDateFilter.value || null,
                search: searchText || null
            };
        }

        // Apply filters to all reports - ENHANCED VERSION
        function applyFilters() {
            const filters = getCurrentFilters();
            
            console.log('Applying filters:', filters);
            console.log('Total reports before filtering:', allReports.length);
            
            // Show loading state for search
            if (filters.search && !isSearching) {
                isSearching = true;
                searchInput.classList.add('loading');
            }
            
            // Filter the reports based on current filters
            filteredReports = allReports.filter(report => {
                // Division filter
                const matchesDivision = !filters.division || 
                    (report.division && report.division === filters.division);
                
                // Quarter filter
                const matchesQuarter = !filters.quarter || 
                    (report.quarter && report.quarter === filters.quarter);
                
                // Date range filter - ENHANCED
                let matchesDateRange = true;
                if (filters.startDate || filters.endDate) {
                    const reportDate = report.reportDate;
                    if (!reportDate) {
                        matchesDateRange = false;
                    } else {
                        const reportDateObj = new Date(reportDate);
                        if (filters.startDate) {
                            const startDateObj = new Date(filters.startDate);
                            if (reportDateObj < startDateObj) matchesDateRange = false;
                        }
                        if (filters.endDate) {
                            const endDateObj = new Date(filters.endDate);
                            endDateObj.setHours(23, 59, 59, 999); // End of day
                            if (reportDateObj > endDateObj) matchesDateRange = false;
                        }
                    }
                }
                
                // Search filter - ENHANCED real-time search
                let matchesSearch = true;
                if (filters.search) {
                    const searchTerms = filters.search.toLowerCase().split(' ');
                    matchesSearch = searchTerms.every(term => 
                        (report.division && report.division.toLowerCase().includes(term)) ||
                        (report.quarter && report.quarter.toLowerCase().includes(term)) ||
                        (report.certifierName && report.certifierName.toLowerCase().includes(term)) ||
                        (report.reportDate && report.reportDate.toLowerCase().includes(term)) ||
                        (report.id && report.id.toLowerCase().includes(term))
                    );
                }
                
                return matchesDivision && matchesQuarter && matchesDateRange && matchesSearch;
            });
            
            console.log('Total reports after filtering:', filteredReports.length);
            
            // Remove loading state
            if (isSearching) {
                isSearching = false;
                searchInput.classList.remove('loading');
            }
            
            // Apply sorting
            sortReports();
            
            // Reset to first page and display
            currentPage = 1;
            displayReports();
            updateSearchResultsInfo();
        }

        // Update search results information
        function updateSearchResultsInfo() {
            if (filteredReports.length === 0 && allReports.length > 0) {
                searchResultsInfo.style.display = 'block';
                resultsCount.textContent = '0';
                totalCount.textContent = allReports.length;
                searchQueryInfo.style.display = 'none';
                dateRangeInfo.style.display = 'none';
            } else if (filteredReports.length < allReports.length) {
                searchResultsInfo.style.display = 'block';
                resultsCount.textContent = filteredReports.length;
                totalCount.textContent = allReports.length;
                
                // Show search query if applicable
                const filters = getCurrentFilters();
                if (filters.search) {
                    searchQueryInfo.style.display = 'inline';
                    queryText.textContent = filters.search;
                } else {
                    searchQueryInfo.style.display = 'none';
                }
                
                // Show date range info if applicable
                if (filters.startDate || filters.endDate) {
                    dateRangeInfo.style.display = 'inline';
                } else {
                    dateRangeInfo.style.display = 'none';
                }
            } else {
                searchResultsInfo.style.display = 'none';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            logoutBtn.addEventListener('click', handleLogout);
            closeModal.addEventListener('click', closePdfModal);
            
            // Enhanced Sorting with visual feedback
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.getAttribute('data-sort');
                    handleSort(column);
                });
            });
            
            // Filtering
            divisionFilter.addEventListener('change', applyFilters);
            quarterFilter.addEventListener('change', applyFilters);
            startDateFilter.addEventListener('change', applyFilters);
            endDateFilter.addEventListener('change', applyFilters);
            
            // Quick Actions
            sortNewestBtn.addEventListener('click', () => {
                handleSort('createdAt', 'desc');
                setActiveQuickAction(sortNewestBtn);
            });
            
            sortOldestBtn.addEventListener('click', () => {
                handleSort('createdAt', 'asc');
                setActiveQuickAction(sortOldestBtn);
            });
            
            sortDivisionBtn.addEventListener('click', () => {
                handleSort('division', 'asc');
                setActiveQuickAction(sortDivisionBtn);
            });
            
            clearFiltersBtn.addEventListener('click', clearAllFilters);
            
            // Pagination
            document.getElementById('entriesSelect').addEventListener('change', function() {
                entriesPerPage = parseInt(this.value);
                currentPage = 1;
                displayReports();
            });
            
            document.getElementById('firstBtn').addEventListener('click', () => goToPage(1));
            document.getElementById('prevBtn').addEventListener('click', () => goToPage(currentPage - 1));
            document.getElementById('nextBtn').addEventListener('click', () => goToPage(currentPage + 1));
            document.getElementById('lastBtn').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredReports.length / entriesPerPage);
                goToPage(totalPages);
            });
            
            // Enhanced Search with real-time feedback
            searchInput.addEventListener('input', debounce(function() {
                applyFilters();
            }, 300));
            
            // Clear data functionality
            clearDataBtn.addEventListener('click', showClearConfirmation);
            confirmClearBtn.addEventListener('click', clearAllData);
            cancelClearBtn.addEventListener('click', hideClearConfirmation);
            
            // Close modals when clicking outside
            clearDataModal.addEventListener('click', function(e) {
                if (e.target === clearDataModal) {
                    hideClearConfirmation();
                }
            });
            
            pdfModal.addEventListener('click', function(e) {
                if (e.target === pdfModal) {
                    closePdfModal();
                }
            });
            
            // Escape key for modals
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    if (pdfModal.style.display === 'block') {
                        closePdfModal();
                    }
                    if (clearDataModal.style.display === 'block') {
                        hideClearConfirmation();
                    }
                }
            });
        }

        // Setup enhanced export listeners
        function setupEnhancedExportListeners() {
            // Enhanced Export Current Data - Export ALL filtered data, not just current page
            exportBtn.addEventListener('click', () => {
                exportToCSV({
                    format: 'detailed',
                    includeMetadata: false,
                    dataSource: 'filtered'  // Changed from 'current' to 'filtered'
                });
            });
            
            // Enhanced Export All Data - Compressed by Quarters
            exportAllBtn.addEventListener('click', exportAllData);
            
            // Export option buttons (commented out but kept for future use)
            if (exportSummaryBtn) {
                exportSummaryBtn.addEventListener('click', () => {
                    exportWithOptions({ format: 'summary', dataSource: 'current' });
                });
            }
            
            if (exportQuarterlyBtn) {
                exportQuarterlyBtn.addEventListener('click', () => {
                    exportWithOptions({ format: 'quarterly', dataSource: 'current' });
                });
            }
            
            if (exportDetailedBtn) {
                exportDetailedBtn.addEventListener('click', () => {
                    exportWithOptions({ format: 'detailed', dataSource: 'current' });
                });
            }
            
            if (exportAllDetailedBtn) {
                exportAllDetailedBtn.addEventListener('click', () => {
                    exportWithOptions({ format: 'detailed', dataSource: 'all' });
                });
            }
        }

        // Set active quick action button
        function setActiveQuickAction(activeBtn) {
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            activeBtn.classList.add('active');
        }

        // Clear all filters
        function clearAllFilters() {
            divisionFilter.value = '';
            quarterFilter.value = '';
            startDateFilter.value = '';
            endDateFilter.value = '';
            searchInput.value = '';
            setupDefaultDates();
            applyFilters();
            setActiveQuickAction(clearFiltersBtn);
        }

        function handleLogout() {
            localStorage.removeItem('userEmail');
            window.location.href = 'login.html';
        }

        function closePdfModal() {
            pdfModal.style.display = 'none';
            pdfViewer.src = '';
        }

        // Navigation functions
        function goToPage(page) {
            if (page < 1) page = 1;
            
            const totalPages = Math.ceil(filteredReports.length / entriesPerPage);
            if (page > totalPages) page = totalPages;
            
            if (page === currentPage) return;
            
            currentPage = page;
            displayReports();
        }

        // Show confirmation modal for clearing data
        function showClearConfirmation() {
            if (totalReports === 0) {
                alert('No data to clear.');
                return;
            }
            clearDataModal.style.display = 'block';
        }

        // Hide confirmation modal
        function hideClearConfirmation() {
            clearDataModal.style.display = 'none';
        }

        // Clear all data from Firestore
        function clearAllData() {
            const originalText = clearDataBtn.textContent;
            
            // Show loading state
            clearDataBtn.disabled = true;
            clearDataBtn.textContent = 'Clearing...';
            hideClearConfirmation();
            
            // Get all documents and delete them in batches
            const batchSize = 500;
            const deleteBatch = (query) => {
                query.limit(batchSize).get().then((snapshot) => {
                    if (snapshot.size === 0) {
                        // All documents deleted
                        resetAfterClear();
                        alert('All data has been cleared successfully.');
                        return;
                    }
                    
                    // Delete documents in batch
                    const batch = db.batch();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    return batch.commit().then(() => {
                        // Recurse on the next batch
                        return deleteBatch(query);
                    });
                });
            };
            
            // Start deletion
            deleteBatch(db.collection('kkpReports'))
                .catch((error) => {
                    console.error('Error clearing data: ', error);
                    alert('Error clearing data. Please try again.');
                })
                .finally(() => {
                    // Reset button state
                    clearDataBtn.disabled = false;
                    clearDataBtn.textContent = originalText;
                });
        }

        function resetAfterClear() {
            // Reset all data
            allReports = [];
            filteredReports = [];
            currentReports = [];
            currentPage = 1;
            totalReports = 0;
            
            // Update UI
            displayReports();
            
            // Reset division filter
            divisionFilter.innerHTML = '<option value="">All Divisions</option>';
            
            // Reload data
            loadAllReports();
        }

        // Enhanced Sorting with visual feedback
        function handleSort(column, direction = null) {
            if (direction) {
                sortColumn = column;
                sortDirection = direction;
            } else {
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
            }
            
            // Update sort indicators and visual feedback
            document.querySelectorAll('.sortable').forEach(th => {
                const indicator = th.querySelector('.sort-indicator');
                th.classList.remove('sort-asc', 'sort-desc');
                
                if (th.getAttribute('data-sort') === sortColumn) {
                    indicator.textContent = sortDirection === 'asc' ? '↑' : '↓';
                    th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                } else {
                    indicator.textContent = '↕';
                }
            });
            
            sortReports();
            displayReports();
        }

        function sortReports() {
            if (!filteredReports.length) return;
            
            filteredReports.sort((a, b) => {
                let aValue = a[sortColumn];
                let bValue = b[sortColumn];
                
                // Handle special cases
                if (sortColumn === 'index') {
                    return sortDirection === 'asc' ? 1 : -1;
                }
                if (sortColumn === 'majorAccidents') {
                    aValue = calculateMajorAccidents(a);
                    bValue = calculateMajorAccidents(b);
                }
                if (sortColumn === 'minorAccidents') {
                    aValue = calculateMinorAccidents(a);
                    bValue = calculateMinorAccidents(b);
                }
                if (sortColumn === 'noInjuryAccidents') {
                    aValue = calculateNoInjuryAccidents(a);
                    bValue = calculateNoInjuryAccidents(b);
                }
                
                // Handle date sorting
                if (sortColumn === 'reportDate' || sortColumn === 'createdAt') {
                    aValue = aValue ? new Date(aValue) : new Date(0);
                    bValue = bValue ? new Date(bValue) : new Date(0);
                }
                
                // Handle null/undefined values
                if (aValue === null || aValue === undefined) aValue = '';
                if (bValue === null || bValue === undefined) bValue = '';
                
                if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // NEW CALCULATION FUNCTIONS FOR UPDATED COLUMNS

        // Calculate Major Accidents (Kematian + Kemalangan Parah)
        function calculateMajorAccidents(report) {
            return (
                parseInt(safeGetValue(report.deathCases, 0)) +
                parseInt(safeGetValue(report.severeAccidents, 0))
            );
        }

        // Calculate Minor Accidents (Kes Rawatan Perubatan + First Aid + Penyakit Pekerjaan)
        function calculateMinorAccidents(report) {
            return (
                parseInt(safeGetValue(report.medicalCases, 0)) +
                parseInt(safeGetValue(report.firstAidCases, 0)) +
                parseInt(safeGetValue(report.occupationalDisease, 0))
            );
        }

        // Calculate No Injury Accidents (Kebakaran + Kerosakan Harta + Kemalangan Perjalanan + Near Miss)
        function calculateNoInjuryAccidents(report) {
            return (
                parseInt(safeGetValue(report.fireCases, 0)) +
                parseInt(safeGetValue(report.propertyDamage, 0)) +
                parseInt(safeGetValue(report.commutingAccidents, 0)) +
                parseInt(safeGetValue(report.nearMiss, 0))
            );
        }

        // Get accident details for display - UPDATED FOR NEW COLUMNS
        function getMajorAccidentDetails(report) {
            const details = [];
            if (report.deathCases && parseInt(report.deathCases) > 0) details.push(`Kematian: ${report.deathCases}`);
            if (report.severeAccidents && parseInt(report.severeAccidents) > 0) details.push(`Parah: ${report.severeAccidents}`);
            return details.length > 0 ? details.join(', ') : 'Tiada kes major';
        }

        function getMinorAccidentDetails(report) {
            const details = [];
            if (report.medicalCases && parseInt(report.medicalCases) > 0) details.push(`Perubatan: ${report.medicalCases}`);
            if (report.firstAidCases && parseInt(report.firstAidCases) > 0) details.push(`First Aid: ${report.firstAidCases}`);
            if (report.occupationalDisease && parseInt(report.occupationalDisease) > 0) details.push(`Penyakit: ${report.occupationalDisease}`);
            return details.length > 0 ? details.join(', ') : 'Tiada kes minor';
        }

        function getNoInjuryAccidentDetails(report) {
            const details = [];
            if (report.fireCases && parseInt(report.fireCases) > 0) details.push(`Kebakaran: ${report.fireCases}`);
            if (report.propertyDamage && parseInt(report.propertyDamage) > 0) details.push(`Kerosakan: ${report.propertyDamage}`);
            if (report.commutingAccidents && parseInt(report.commutingAccidents) > 0) details.push(`Perjalanan: ${report.commutingAccidents}`);
            if (report.nearMiss && parseInt(report.nearMiss) > 0) details.push(`Near Miss: ${report.nearMiss}`);
            return details.length > 0 ? details.join(', ') : 'Tiada kes tiada kecederaan';
        }

        // Display reports in the table - UPDATED FOR NEW COLUMNS
        function displayReports() {
            if (!filteredReports.length) {
                tableBody.innerHTML = '<tr><td colspan="10">No reports found.</td></tr>';
                updatePagination();
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * entriesPerPage;
            const endIndex = startIndex + entriesPerPage;
            currentReports = filteredReports.slice(startIndex, endIndex);
            
            tableBody.innerHTML = '';
            
            currentReports.forEach((report, index) => {
                const globalIndex = startIndex + index + 1;
                const majorAccidents = calculateMajorAccidents(report);
                const minorAccidents = calculateMinorAccidents(report);
                const noInjuryAccidents = calculateNoInjuryAccidents(report);
                
                const majorDetails = getMajorAccidentDetails(report);
                const minorDetails = getMinorAccidentDetails(report);
                const noInjuryDetails = getNoInjuryAccidentDetails(report);
                
                const reportDate = report.reportDate ? new Date(report.reportDate).toLocaleDateString('ms-MY') : 'N/A';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${globalIndex}</td>
                    <td>${safeGetValue(report.division)}</td>
                    <td>${safeGetValue(report.quarter)}</td>
                    <td>${safeGetValue(report.deathCases, '0')}</td>
                    <!-- NEW COLUMNS WITH NESTED INFORMATION -->
                    <td>
                        ${majorAccidents}
                        <div class="accident-details">${majorDetails}</div>
                    </td>
                    <td>
                        ${minorAccidents}
                        <div class="accident-details">${minorDetails}</div>
                    </td>
                    <td>
                        ${noInjuryAccidents}
                        <div class="accident-details">${noInjuryDetails}</div>
                    </td>
                    <!-- END NEW COLUMNS -->
                    <td>${safeGetValue(report.certifierName)}</td>
                    <td>${reportDate}</td>
                    <td>
                        <div class="button-container">
                            <button class="view-btn" data-id="${report.id}" aria-label="View PDF for ${report.division} ${report.quarter} report">View PDF</button>
                            <button class="download-btn" data-id="${report.id}" aria-label="Download ${report.division} ${report.quarter} report">Download</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const reportId = e.target.getAttribute('data-id');
                    viewPdf(reportId);
                });
            });
            
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const reportId = e.target.getAttribute('data-id');
                    downloadReport(reportId);
                });
            });
            
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredReports.length / entriesPerPage);
            const pageInfo = document.getElementById('pageInfo');
            const firstBtn = document.getElementById('firstBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const lastBtn = document.getElementById('lastBtn');
            
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            firstBtn.disabled = currentPage === 1;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            lastBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // View PDF in modal
        function viewPdf(reportId) {
            const report = allReports.find(r => r.id === reportId);
            if (!report || !report.pdfData) {
                alert('PDF not available for this report');
                return;
            }
            
            pdfTitle.textContent = `KKP Report - ${safeGetValue(report.division)} - ${safeGetValue(report.quarter)}`;
            pdfViewer.src = report.pdfData;
            pdfModal.style.display = 'block';
        }

        // Download the EXACT PDF that was originally generated
        function downloadReport(reportId) {
            const report = allReports.find(r => r.id === reportId);
            if (!report || !report.pdfData) {
                alert('PDF not available for this report');
                return;
            }
            
            const link = document.createElement('a');
            link.href = report.pdfData;
            link.download = `KKP_Report_${safeGetValue(report.division, 'Unknown')}_${safeGetValue(report.quarter, 'Unknown')}.pdf`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // =========================================================================
        // ENHANCED CSV EXPORT FUNCTIONALITY - UPDATED FOR NEW COLUMNS
        // =========================================================================

        // Enhanced export function with options
        function exportWithOptions(options = {}) {
            const mergedOptions = { ...exportOptions, ...options };
            
            if (mergedOptions.format === 'summary') {
                exportSummaryReport(mergedOptions);
            } else if (mergedOptions.format === 'quarterly') {
                exportQuarterlySummary(mergedOptions);
            } else {
                const reports = mergedOptions.dataSource === 'all' ? allReports : currentReports;
                exportDetailedReport(reports, mergedOptions);
            }
        }

        // Enhanced Export Current Data with ALL filtered data
        function exportToCSV(options = {}) {
            const defaultOptions = {
                format: 'detailed',
                includeMetadata: false,
                groupBy: 'none',
                dataSource: 'filtered' // 'filtered', 'current', or 'all'
            };
            
            const mergedOptions = { ...defaultOptions, ...options };
            
            // Determine which data to export based on dataSource
            let reportsToExport;
            switch (mergedOptions.dataSource) {
                case 'all':
                    reportsToExport = allReports;
                    break;
                case 'filtered':
                    reportsToExport = filteredReports;
                    break;
                case 'current':
                    reportsToExport = currentReports;
                    break;
                default:
                    reportsToExport = filteredReports; // Default to filtered data
            }
            
            if (reportsToExport.length === 0) {
                alert('Tiada data untuk dieksport. Sila semak penapisan anda.');
                return;
            }

            // Show loading state for export button
            const originalText = exportBtn.textContent;
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span class="export-loading"></span>Menyediakan Eksport...';

            try {
                // Validate data before export
                validateExportData(reportsToExport);
                
                // Show export summary in console
                showExportSummary(reportsToExport, mergedOptions);
                
                // Perform the export
                exportDetailedReport(reportsToExport, mergedOptions);
                
            } catch (error) {
                console.error('Export validation failed:', error);
                alert(`Eksport gagal: ${error.message}`);
            } finally {
                // Reset button state
                setTimeout(() => {
                    exportBtn.disabled = false;
                    exportBtn.textContent = originalText;
                }, 1000);
            }
        }

        // Enhanced Export All Data - Compressed by Quarters
        function exportAllData() {
            const originalText = exportAllBtn.textContent;
            
            // Show loading state
            exportAllBtn.disabled = true;
            exportAllBtn.innerHTML = '<span class="export-loading"></span>Exporting All Data...';
            
            // Fetch ALL data from Firestore
            db.collection('kkpReports')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        alert('No data found in the database to export.');
                        resetExportAllButton(originalText);
                        return;
                    }
                    
                    const allReportsData = [];
                    querySnapshot.forEach((doc) => {
                        const report = doc.data();
                        report.id = doc.id;
                        allReportsData.push(report);
                    });
                    
                    // Export with quarter compression
                    exportAllDataByQuarters(allReportsData);
                    resetExportAllButton(originalText);
                    
                })
                .catch((error) => {
                    console.error('Error fetching all data for export: ', error);
                    alert('Error exporting all data. Please try again.');
                    resetExportAllButton(originalText);
                });
        }

        // New function to export all data compressed by quarters
        function exportAllDataByQuarters(reports) {
            const csvRows = [];
            const timestamp = new Date();
            
            // Title and headers with enhanced information
            csvRows.push(',,,,LAPORAN KKP - SEMUA DATA MENGIKUT SUKU');
            csvRows.push(',,,,');
            csvRows.push(`",,,,Dijana pada: ${timestamp.toLocaleString('ms-MY')}"`);
            csvRows.push(`",,,,Jumlah Rekod Asal: ${reports.length}"`);
            csvRows.push(',,,,');
            
            // Group reports by quarter
            const quartersData = {
                'Suku 1': { reports: [], total: 0 },
                'Suku 2': { reports: [], total: 0 },
                'Suku 3': { reports: [], total: 0 },
                'Suku 4': { reports: [], total: 0 }
            };
            
            // Organize reports by quarter
            reports.forEach(report => {
                const quarter = report.quarter || 'Unknown';
                if (quartersData[quarter]) {
                    quartersData[quarter].reports.push(report);
                    quartersData[quarter].total++;
                }
            });
            
            // Headers for quarter-compressed data - UPDATED FOR NEW COLUMNS
            const headers = [
                'Suku',
                'Jumlah Laporan',
                // Section A: STATISTIK - BILANGAN only
                'A1. Jumlah Bilangan Pekerja',
                'A2. Jumlah Cuti Sakit Pekerja Disebabkan Kemalangan',
                // NEW COLUMNS FOR ACCIDENT CATEGORIES
                'Kes Kemalangan Major (Kematian + Parah)',
                'Kes Kemalangan Minor (Perubatan + First Aid + Penyakit)',
                'Kes Kemalangan Tiada Kecederaan (Kebakaran + Kerosakan + Perjalanan + Near Miss)',
                // Section C: REKOD KES BERKAITAN KESIHATAN - BILANGAN KES only
                'C1. Kes Penyakit Berjangkit',
                // Section D: PROGRAM KKP - BILANGAN only
                'D1. Jumlah Mesyuarat KKP',
                'D2. Jumlah Latihan KKP',
                'D3. Jumlah Taklimat/Toolbox',
                'D4. Jumlah Pemeriksaan KKP',
                'D5. Pelaporan UAUC',
                'D6. Lain-lain Aktiviti KKP'
            ];
            
            csvRows.push(headers.join(','));
            
            // Process each quarter
            Object.entries(quartersData).forEach(([quarter, data]) => {
                if (data.reports.length > 0) {
                    const quarterTotals = calculateQuarterTotals(data.reports);
                    const row = [
                        escapeCsvValue(quarter),
                        data.total,
                        // Section A
                        quarterTotals.totalWorkers,
                        quarterTotals.sickLeave,
                        // NEW ACCIDENT CATEGORIES
                        quarterTotals.majorAccidents,
                        quarterTotals.minorAccidents,
                        quarterTotals.noInjuryAccidents,
                        // Section C
                        quarterTotals.infectiousDisease,
                        // Section D
                        quarterTotals.meetings,
                        quarterTotals.trainings,
                        quarterTotals.briefings,
                        quarterTotals.inspections,
                        quarterTotals.uauc,
                        quarterTotals.otherActivities
                    ];
                    
                    csvRows.push(row.join(','));
                }
            });
            
            // Add enhanced summary statistics for all quarters combined
            addEnhancedSummaryForAllQuarters(csvRows, reports);
            
            const filename = `Laporan_KKP_SemuaData_MengikutSuku_${new Date().toISOString().split('T')[0]}`;
            createAndDownloadCsv(csvRows, filename);
        }

        // Calculate totals for a set of reports in a quarter - UPDATED
        function calculateQuarterTotals(reports) {
            const totals = {
                totalWorkers: 0,
                sickLeave: 0,
                // NEW ACCIDENT CATEGORIES
                majorAccidents: 0,
                minorAccidents: 0,
                noInjuryAccidents: 0,
                // Section C
                infectiousDisease: 0,
                // Section D
                meetings: 0,
                trainings: 0,
                briefings: 0,
                inspections: 0,
                uauc: 0,
                otherActivities: 0
            };
            
            reports.forEach(report => {
                totals.totalWorkers += parseInt(safeGetValue(report.totalWorkers, '0'));
                totals.sickLeave += parseInt(safeGetValue(report.sickLeave, '0'));
                // NEW CALCULATIONS
                totals.majorAccidents += calculateMajorAccidents(report);
                totals.minorAccidents += calculateMinorAccidents(report);
                totals.noInjuryAccidents += calculateNoInjuryAccidents(report);
                // Section C
                totals.infectiousDisease += parseInt(safeGetValue(report.infectiousDisease, '0'));
                // Section D
                totals.meetings += parseInt(safeGetValue(report.meetings, '0'));
                totals.trainings += parseInt(safeGetValue(report.trainings, '0'));
                totals.briefings += parseInt(safeGetValue(report.briefings, '0'));
                totals.inspections += parseInt(safeGetValue(report.inspections, '0'));
                totals.uauc += parseInt(safeGetValue(report.uauc, '0'));
                totals.otherActivities += parseInt(safeGetValue(report.otherActivities, '0'));
            });
            
            return totals;
        }

        // Enhanced summary for all quarters combined - UPDATED
        function addEnhancedSummaryForAllQuarters(csvRows, reports) {
            if (reports.length === 0) return;
            
            csvRows.push(',,,,');
            csvRows.push(',,,,STATISTIK TERPERINCI - SEMUA SUKU');
            csvRows.push(',,,,');
            
            const summaries = {
                'Total Laporan': reports.length,
                'Total Jumlah Cuti Sakit Pekerja Disebabkan Kemalangan': sumField(reports, 'sickLeave'),
                // NEW ACCIDENT CATEGORIES
                'Total Kes Kemalangan Major': reports.reduce((sum, report) => sum + calculateMajorAccidents(report), 0),
                'Total Kes Kemalangan Minor': reports.reduce((sum, report) => sum + calculateMinorAccidents(report), 0),
                'Total Kes Kemalangan Tiada Kecederaan': reports.reduce((sum, report) => sum + calculateNoInjuryAccidents(report), 0),
                // Section C
                'Total Penyakit Berjangkit': sumField(reports, 'infectiousDisease'),
                // Section D
                'Total Jumlah Mesyuarat KKP': sumField(reports, 'meetings'),
                'Total Jumlah Latihan KKP': sumField(reports, 'trainings'),
                'Total Jumlah Taklimat/Toolbox': sumField(reports, 'briefings'),
                'Total Jumlah Pemeriksaan KKP (Pemeriksaan Dalaman & Luaran)': sumField(reports, 'inspections'),
                'Total Pelaporan Unsafe Act Unsafe Condition (UAUC)': sumField(reports, 'uauc'),
                'Total Lain-lain (Contohnya, Kempen atau Promosi Berkaitan KKP)': sumField(reports, 'otherActivities')
            };
            
            Object.entries(summaries).forEach(([label, value]) => {
                csvRows.push(`"${label}","${value}",,,`);
            });
            
            // Add quarter distribution
            csvRows.push(',,,,');
            csvRows.push(',,,,TABURAN MENGIKUT SUKU');
            
            const quarterDistribution = {
                'Suku 1': 0,
                'Suku 2': 0,
                'Suku 3': 0,
                'Suku 4': 0,
                'Unknown': 0
            };
            
            reports.forEach(report => {
                const quarter = report.quarter || 'Unknown';
                quarterDistribution[quarter] = (quarterDistribution[quarter] || 0) + 1;
            });
            
            Object.entries(quarterDistribution).forEach(([quarter, count]) => {
                if (count > 0) {
                    const percentage = ((count / reports.length) * 100).toFixed(1);
                    csvRows.push(`"${quarter}","${count} laporan (${percentage}%)",,,`);
                }
            });
        }

        // Show export summary before download
        function showExportSummary(reports, options) {
            const totalRecords = reports.length;
            const totalMajor = reports.reduce((sum, report) => sum + calculateMajorAccidents(report), 0);
            const totalMinor = reports.reduce((sum, report) => sum + calculateMinorAccidents(report), 0);
            const totalNoInjury = reports.reduce((sum, report) => sum + calculateNoInjuryAccidents(report), 0);
            
            const dataSourceText = options.dataSource === 'all' ? 'Semua Data' : 
                                  options.dataSource === 'filtered' ? 'Data Terfilter' : 'Data Halaman Semasa';
            
            console.log(`
🎯 Eksport Siap!

Butiran Eksport:
- Sumber Data: ${dataSourceText}
- Jumlah Rekod: ${totalRecords}
- Kes Major: ${totalMajor}
- Kes Minor: ${totalMinor}
- Kes Tiada Kecederaan: ${totalNoInjury}
- Format: ${options.format}

Fail CSV akan dimuat turun secara automatik.
            `);
        }

        // 1. Detailed Report Export (Enhanced) - UPDATED FOR NEW COLUMNS
        function exportDetailedReport(reports, options = {}) {
            const csvRows = [];
            const timestamp = new Date();
            const filters = getCurrentFilters();
            
            // Title and headers with enhanced information
            csvRows.push(',,,,LAPORAN KKP - DATA TERPERINCI');
            csvRows.push(',,,,');
            csvRows.push(`",,,,Dijana pada: ${timestamp.toLocaleString('ms-MY')}"`);
            csvRows.push(`",,,,Jumlah Rekod: ${reports.length}"`);
            
            // Add filter information if any filters are active
            const activeFilters = getActiveFilterInfo(filters);
            if (activeFilters) {
                csvRows.push(`",,,,Filter: ${activeFilters}"`);
            }
            csvRows.push(',,,,');
            
            // Enhanced headers with better grouping - UPDATED
            const headers = [
                'No',
                'Bahagian/Unit',
                'Suku', 
                'Tarikh Laporan',
                'Pegawai Mengaku',
                // Section A: STATISTIK - BILANGAN only
                'A1. Jumlah Bilangan Pekerja',
                'A2. Jumlah Cuti Sakit Pekerja Disebabkan Kemalangan',
                // NEW ACCIDENT CATEGORIES
                'Kes Kemalangan Major (Kematian + Parah)',
                'Kes Kemalangan Minor (Perubatan + First Aid + Penyakit)',
                'Kes Kemalangan Tiada Kecederaan (Kebakaran + Kerosakan + Perjalanan + Near Miss)',
                // Section C: REKOD KES BERKAITAN KESIHATAN - BILANGAN KES only
                'C1. Kes Penyakit Berjangkit',
                // Section D: PROGRAM KKP - BILANGAN only
                'D1. Jumlah Mesyuarat KKP',
                'D2. Jumlah Latihan KKP',
                'D3. Jumlah Taklimat/Toolbox',
                'D4. Jumlah Pemeriksaan KKP',
                'D5. Pelaporan UAUC',
                'D6. Lain-lain Aktiviti KKP'
            ];
            
            csvRows.push(headers.join(','));
            
            // Add data rows with validation
            let validReportsCount = 0;
            reports.forEach((report, index) => {
                if (!isValidReport(report)) {
                    console.warn('Skipping invalid report:', report.id);
                    return;
                }
                validReportsCount++;
                
                const displayIndex = options.dataSource === 'all' ? index + 1 : getGlobalIndex(index);
                
                const row = [
                    displayIndex,
                    escapeCsvValue(report.division),
                    escapeCsvValue(report.quarter),
                    escapeCsvValue(formatDateForExport(report.reportDate)),
                    escapeCsvValue(report.certifierName),
                    // Section A: BILANGAN only
                    safeGetValue(report.totalWorkers, '0'),
                    safeGetValue(report.sickLeave, '0'),
                    // NEW ACCIDENT CATEGORIES
                    calculateMajorAccidents(report),
                    calculateMinorAccidents(report),
                    calculateNoInjuryAccidents(report),
                    // Section C: BILANGAN KES only
                    safeGetValue(report.infectiousDisease, '0'),
                    // Section D: BILANGAN only
                    safeGetValue(report.meetings, '0'),
                    safeGetValue(report.trainings, '0'),
                    safeGetValue(report.briefings, '0'),
                    safeGetValue(report.inspections, '0'),
                    safeGetValue(report.uauc, '0'),
                    safeGetValue(report.otherActivities, '0')
                ];
                
                csvRows.push(row.join(','));
            });
            
            // Add enhanced summary statistics - UPDATED
            addEnhancedSummary(csvRows, reports);
            
            // Add data quality information
            csvRows.push(',,,,');
            csvRows.push(`"Rekod Valid","${validReportsCount}","Rekod Tidak Valid","${reports.length - validReportsCount}","Jumlah","${reports.length}"`);
            
            const filename = generateExportFilename('Laporan_KKP_Data_Terperinci', filters, options);
            createAndDownloadCsv(csvRows, filename);
        }

        // 2. Summary Report Export - UPDATED
        function exportSummaryReport(options = {}) {
            const reports = options.dataSource === 'all' ? allReports : currentReports;
            const csvRows = [];
            const timestamp = new Date();
            const filters = getCurrentFilters();
            
            csvRows.push(',,,,RINGKASAN LAPORAN KKP');
            csvRows.push(',,,,');
            csvRows.push(`",,,,Dijana pada: ${timestamp.toLocaleString('ms-MY')}"`);
            csvRows.push(`",,,,Jumlah Rekod: ${reports.length}"`);
            
            const activeFilters = getActiveFilterInfo(filters);
            if (activeFilters) {
                csvRows.push(`",,,,Filter: ${activeFilters}"`);
            }
            csvRows.push(',,,,');
            
            // Summary headers - UPDATED
            const headers = [
                'Bahagian/Unit',
                'Suku',
                'Tarikh Laporan',
                'Kematian',
                'Kes Kemalangan Major',
                'Kes Kemalangan Minor',
                'Kes Kemalangan Tiada Kecederaan',
                'Pegawai Mengaku'
            ];
            
            csvRows.push(headers.join(','));
            
            // Summary data
            reports.forEach((report) => {
                if (!isValidReport(report)) return;
                
                const row = [
                    escapeCsvValue(report.division),
                    escapeCsvValue(report.quarter),
                    escapeCsvValue(formatDateForExport(report.reportDate)),
                    safeGetValue(report.deathCases, '0'),
                    calculateMajorAccidents(report),
                    calculateMinorAccidents(report),
                    calculateNoInjuryAccidents(report),
                    escapeCsvValue(report.certifierName)
                ];
                
                csvRows.push(row.join(','));
            });
            
            // Add quarterly summary
            const quarterlySummary = generateQuarterlySummary(reports);
            addQuarterlySummaryToCsv(csvRows, quarterlySummary);
            
            const filename = generateExportFilename('Ringkasan_KKP', filters, options);
            createAndDownloadCsv(csvRows, filename);
        }

        // 3. Quarterly Summary Export - UPDATED
        function exportQuarterlySummary(options = {}) {
            const reports = options.dataSource === 'all' ? allReports : currentReports;
            const csvRows = [];
            const timestamp = new Date();
            const filters = getCurrentFilters();
            
            csvRows.push(',,,,LAPORAN KUARTA KKP');
            csvRows.push(',,,,');
            csvRows.push(`",,,,Dijana pada: ${timestamp.toLocaleString('ms-MY')}"`);
            csvRows.push(`",,,,Jumlah Rekod: ${reports.length}"`);
            
            const activeFilters = getActiveFilterInfo(filters);
            if (activeFilters) {
                csvRows.push(`",,,,Filter: ${activeFilters}"`);
            }
            csvRows.push(',,,,');
            
            const quarterlyData = generateQuarterlySummary(reports);
            
            // Quarterly headers - UPDATED
            const headers = [
                'Suku',
                'Bilangan Laporan',
                'Kes Kemalangan Major',
                'Kes Kemalangan Minor',
                'Kes Kemalangan Tiada Kecederaan',
                'Jumlah Keseluruhan'
            ];
            
            csvRows.push(headers.join(','));
            
            // Quarterly data
            Object.entries(quarterlyData).forEach(([quarter, data]) => {
                const total = data.majorAccidents + data.minorAccidents + data.noInjuryAccidents;
                const row = [
                    escapeCsvValue(quarter),
                    data.reports,
                    data.majorAccidents,
                    data.minorAccidents,
                    data.noInjuryAccidents,
                    total
                ];
                
                csvRows.push(row.join(','));
            });
            
            // Add overall totals
            addQuarterlyTotalSummary(csvRows, quarterlyData);
            
            const filename = generateExportFilename('Laporan_Kuarta_KKP', filters, options);
            createAndDownloadCsv(csvRows, filename);
        }

        // =========================================================================
        // HELPER FUNCTIONS - UPDATED
        // =========================================================================

        // Enhanced data validation
        function validateExportData(reports) {
            if (!reports || reports.length === 0) {
                throw new Error('Tiada data untuk dieksport');
            }
            
            const invalidReports = reports.filter(report => !isValidReport(report));
            if (invalidReports.length === reports.length) {
                throw new Error('Semua data tidak valid untuk dieksport');
            }
            
            return true;
        }

        function isValidReport(report) {
            return report && 
                   report.division && 
                   report.quarter && 
                   report.reportDate &&
                   report.certifierName;
        }

        // Enhanced summary statistics - UPDATED VERSION
        function addEnhancedSummary(csvRows, reports) {
            if (reports.length === 0) return;
            
            csvRows.push(',,,,');
            csvRows.push(',,,,STATISTIK TERPERINCI');
            csvRows.push(',,,,');
            
            const summaries = {
                'Total Laporan': reports.length,
                'Total Jumlah Cuti Sakit Pekerja Disebabkan Kemalangan': sumField(reports, 'sickLeave'),
                // NEW ACCIDENT CATEGORIES
                'Total Kes Kemalangan Major': reports.reduce((sum, report) => sum + calculateMajorAccidents(report), 0),
                'Total Kes Kemalangan Minor': reports.reduce((sum, report) => sum + calculateMinorAccidents(report), 0),
                'Total Kes Kemalangan Tiada Kecederaan': reports.reduce((sum, report) => sum + calculateNoInjuryAccidents(report), 0),
                // Section C
                'Total Penyakit Berjangkit': sumField(reports, 'infectiousDisease'),
                // Section D
                'Total Jumlah Mesyuarat KKP': sumField(reports, 'meetings'),
                'Total Jumlah Latihan KKP': sumField(reports, 'trainings'),
                'Total Jumlah Taklimat/Toolbox': sumField(reports, 'briefings'),
                'Total Jumlah Pemeriksaan KKP (Pemeriksaan Dalaman & Luaran)': sumField(reports, 'inspections'),
                'Total Pelaporan Unsafe Act Unsafe Condition (UAUC)': sumField(reports, 'uauc'),
                'Total Lain-lain (Contohnya, Kempen atau Promosi Berkaitan KKP)': sumField(reports, 'otherActivities')
            };
            
            Object.entries(summaries).forEach(([label, value]) => {
                csvRows.push(`"${label}","${value}",,,`);
            });
        }

        // Quarterly aggregation - UPDATED
        function generateQuarterlySummary(reports) {
            const quarterlyData = {};
            
            reports.forEach(report => {
                if (!isValidReport(report)) return;
                
                const quarter = report.quarter;
                if (!quarterlyData[quarter]) {
                    quarterlyData[quarter] = {
                        reports: 0,
                        majorAccidents: 0,
                        minorAccidents: 0,
                        noInjuryAccidents: 0
                    };
                }
                
                quarterlyData[quarter].reports++;
                quarterlyData[quarter].majorAccidents += calculateMajorAccidents(report);
                quarterlyData[quarter].minorAccidents += calculateMinorAccidents(report);
                quarterlyData[quarter].noInjuryAccidents += calculateNoInjuryAccidents(report);
            });
            
            return quarterlyData;
        }

        function addQuarterlySummaryToCsv(csvRows, quarterlyData) {
            csvRows.push(',,,,');
            csvRows.push(',,,,RINGKASAN KUARTA');
            
            Object.entries(quarterlyData).forEach(([quarter, data]) => {
                const total = data.majorAccidents + data.minorAccidents + data.noInjuryAccidents;
                csvRows.push(`"${quarter}","${data.reports} laporan","${total} jumlah kes",,,`);
            });
        }

        function addQuarterlyTotalSummary(csvRows, quarterlyData) {
            csvRows.push(',,,,');
            csvRows.push(',,,,JUMLAH KESELURUHAN');
            
            const totals = {
                reports: 0,
                majorAccidents: 0,
                minorAccidents: 0,
                noInjuryAccidents: 0
            };
            
            Object.values(quarterlyData).forEach(data => {
                Object.keys(totals).forEach(key => {
                    totals[key] += data[key] || 0;
                });
            });
            
            const overallTotal = totals.majorAccidents + totals.minorAccidents + totals.noInjuryAccidents;
            csvRows.push(`"Jumlah","${totals.reports}","${totals.majorAccidents}","${totals.minorAccidents}","${totals.noInjuryAccidents}","${overallTotal}"`);
        }

        // Utility functions
        function sumField(reports, field) {
            return reports.reduce((sum, report) => sum + parseInt(safeGetValue(report[field], '0')), 0);
        }

        function getGlobalIndex(index) {
            const startIndex = (currentPage - 1) * entriesPerPage;
            return startIndex + index + 1;
        }

        function formatDateForExport(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('ms-MY');
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('ms-MY');
        }

        function getActiveFilterInfo(filters) {
            const activeFilters = [];
            if (filters.division) activeFilters.push(`Bahagian: ${filters.division}`);
            if (filters.quarter) activeFilters.push(`Suku: ${filters.quarter}`);
            if (filters.search) activeFilters.push(`Carian: "${filters.search}"`);
            if (filters.startDate || filters.endDate) {
                const dateRange = [];
                if (filters.startDate) dateRange.push(formatDateForExport(filters.startDate));
                if (filters.endDate) dateRange.push(formatDateForExport(filters.endDate));
                activeFilters.push(`Tempoh: ${dateRange.join(' - ')}`);
            }
            
            return activeFilters.join(', ');
        }

        function generateExportFilename(prefix, filters, options) {
            const timestamp = new Date().toISOString().split('T')[0];
            let sourceInfo = '';
            
            // Add data source information
            if (options.dataSource === 'all') {
                sourceInfo = '_SemuaData';
            } else if (options.dataSource === 'filtered') {
                sourceInfo = '_DataTerfilter';
                // Add filter info for filtered data
                if (filters.division) sourceInfo += `_${filters.division.replace(/\s+/g, '')}`;
                if (filters.quarter) sourceInfo += `_${filters.quarter.replace(/\s+/g, '')}`;
            } else {
                sourceInfo = '_HalamanSemasa';
            }
            
            return `${prefix}${sourceInfo}_${timestamp}`;
        }

        // Enhanced CSV value escaping
        function escapeCsvValue(value) {
            if (value === null || value === undefined) return '';
            
            const stringValue = String(value);
            
            // Escape quotes and wrap in quotes if contains comma, quote, or newline
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') || stringValue.includes('\r')) {
                return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            
            return stringValue;
        }

        // Create and trigger download
        function createAndDownloadCsv(csvRows, filename) {
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up URL object
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        // Reset export button
        function resetExportAllButton(originalText) {
            exportAllBtn.disabled = false;
            exportAllBtn.textContent = originalText;
        }
    </script>
</body>
</html>
